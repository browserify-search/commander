#! /usr/bin/env node

var request = require('superagent')
var auth = require(__dirname + '/../auth.json')
var async = require('async')
var allDroplets = require('../lib/all_droplets')

allDroplets(function(err, droplets){
  if (err) return console.error(err.message)
  var active = droplets.filter(function(d){
    return d.status === 'active'
  })

  async.eachSeries(active, 
    function(droplet, next){
      var url = 
        'https://api.digitalocean.com/droplets/' + 
        droplet.id + 
        '/power_off/'
      request.get(url)
        .query(auth)
        .end(function(err, reply){
          if (err) return next(err)
          if (reply.error) return next(reply.error)
          console.log('Shutdown', droplet.name, 'ok')
          next()
        })
    },
    function(err){
      if (err) console.error(err.message)
      else console.log('ok')
    })
  
})
